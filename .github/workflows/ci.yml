name: CI

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

env:
  CARGO_TERM_COLOR: always

jobs:
  format:
    name: Format Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt

      - name: Rustfmt Check
        run: cargo fmt --all -- --check

  clippy:
    name: Clippy Check
    runs-on: ubuntu-latest
    strategy:
      matrix:
        features:
          - ""                                    # No features
          - "multithreading"                      # Multithreading (full)
    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libffi-dev

      - name: Clippy Check (${{ matrix.features || 'no features' }})
        run: |
          if [ -z "${{ matrix.features }}" ]; then
            cargo clippy --all-targets --no-default-features -- -D warnings
          else
            cargo clippy --all-targets --no-default-features --features ${{ matrix.features }} -- -D warnings
          fi

  test:
    name: Test Suite
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          # Single-threaded configurations
          - name: "No features"
            features: ""

          # Multithreading configurations (full)
          - name: "Multithreading"
            features: "multithreading"

    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libffi-dev

      - name: Build (${{ matrix.name }})
        run: |
          if [ -z "${{ matrix.features }}" ]; then
            cargo build --verbose --no-default-features
          else
            cargo build --verbose --no-default-features --features ${{ matrix.features }}
          fi

      - name: Run tests (${{ matrix.name }})
        run: |
          if [ -z "${{ matrix.features }}" ]; then
            cargo test --verbose --no-default-features
          else
            cargo test --verbose --no-default-features --features ${{ matrix.features }}
          fi